package gas.alarm;

import fr.liglab.adele.icasa.clockservice.Clock;
import fr.liglab.adele.icasa.command.handler.Command;
import fr.liglab.adele.icasa.device.security.Siren;
import mail.services.MailSender;

import org.joda.time.DateTime;

import java.util.HashSet;
import java.util.Set;

public class ReportManager implements GasAlarmListener {

    private Set<String> adressToNotify = new HashSet<String>();

    private final Object m_lock;
    @Requires
    private Clock clock;

    @Requires(id="mailService")
    private MailSender mailSender;

    @Requires
    private GasAlarmService gasAlarmService;

    public ReportManager() {
        m_lock = new Object();
    }

    public void stop() {
        System.out.println(" Report component stop ... ");
        gasAlarmService.removeListener(this);
    }

    public void start() {
        System.out.println(" Report Manager component start ... ");
        gasAlarmService.addListener(this);
    }

    @Override
    public void thresholdCrossUp() {
        synchronized (m_lock){
            for(String adress : adressToNotify){
                DateTime dateTime = new DateTime(clock.currentTimeMillis());

                if(mailSender.sendSimpleMail(adress, "CO2 concentration is too hight", " Hello , \n\r" +
                        "The Co2 concentration is higher than the maximum Threshold. The Alarm procedure start at " + dateTime.getHourOfDay() +":"+dateTime.getMinuteOfHour()+":"+dateTime.getSecondOfMinute() + " the " + dateTime.getDayOfMonth()+"/" + dateTime.getMonthOfYear()+"/"+ dateTime.getYear())){
                    System.out.println(" Report manager can't send to " + adress);
                }
            }
        }
    }

    @Override
    public void thresholdCrossDown() {

    }

    @Command
    public void addReportAdress(String adress){
        synchronized (m_lock){
            adressToNotify.add(adress);
        }
        System.out.println(" Adress " + adress + " was add to the reporting list");
    }

}
